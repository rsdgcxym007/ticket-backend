#!/bin/bash

# ========================================
# ЁЯзк р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕гр╕▒р╕Щр╣Ар╕Чр╕кр╕Хр╣Мр╕гр╕░р╕Ър╕Ър╕Ир╕нр╕Зр╕Хр╕▒р╣Лр╕з
# ========================================

echo "ЁЯОп р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕гр╕┤р╣Ир╕бр╣Ар╕Чр╕кр╕Хр╣Мр╕гр╕░р╕Ър╕Ър╕Ир╕нр╕Зр╕Хр╕▒р╣Лр╕з..."
echo ""

# р╣Ар╕Кр╣Зр╕Др╕зр╣Ир╕▓р╣Вр╕Ыр╕гр╣Ар╕Ир╕Др╕Юр╕гр╣Йр╕нр╕бр╕гр╕▒р╕Щр╕бр╕▒р╣Йр╕в
echo "ЁЯУЛ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕зр╕▓р╕бр╕Юр╕гр╣Йр╕нр╕б..."
if ! command -v npm &> /dev/null; then
    echo "тЭМ р╣Др╕бр╣Ир╕Юр╕Ъ npm р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Node.js р╕Бр╣Ир╕нр╕Щ"
    exit 1
fi

echo "тЬЕ npm р╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ"

# р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З dependencies р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡
if [ ! -d "node_modules" ]; then
    echo "ЁЯУж р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З dependencies..."
    npm install
fi

echo ""
echo "========================================="
echo "ЁЯзк р╣Ар╕бр╕Щр╕╣р╕Бр╕▓р╕гр╣Ар╕Чр╕кр╕Хр╣М"
echo "========================================="
echo "1. р╣Ар╕Чр╕кр╕Хр╣Мр╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ (Unit Tests)"
echo "2. р╣Ар╕Чр╕кр╕Хр╣М API (E2E Tests)" 
echo "3. р╣Ар╕Чр╕кр╕Хр╣Мр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕З (р╕Др╕гр╕Ър╕Чр╕╕р╕Бр╣Ар╕Др╕к)"
echo "4. р╣Ар╕Чр╕кр╕Хр╣Мр╣Ар╕Йр╕Юр╕▓р╕░ Order Service"
echo "5. р╕Фр╕╣р╕кр╕Цр╕▓р╕Щр╕░р╕Бр╕▓р╕гр╕Др╕нр╕бр╣Др╕Юр╕ер╣М"
echo "========================================="

read -p "р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕▓р╕вр╣Ар╕ер╕В (1-5): " choice

case $choice in
    1)
        echo "ЁЯзк р╕Бр╕│р╕ер╕▒р╕Зр╕гр╕▒р╕Щ Unit Tests..."
        npm run test
        ;;
    2)
        echo "ЁЯМР р╕Бр╕│р╕ер╕▒р╕Зр╕гр╕▒р╕Щ E2E Tests..."
        echo "тЪая╕П  р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Чр╕кр╕Хр╣М"
        npm run test:e2e
        ;;
    3)
        echo "ЁЯЪА р╕Бр╕│р╕ер╕▒р╕Зр╕гр╕▒р╕Щр╣Ар╕Чр╕кр╕Хр╣Мр╕Чр╕╕р╕Бр╣Ар╕Др╕к..."
        echo "1я╕ПтГг р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Др╕нр╕бр╣Др╕Юр╕ер╣М..."
        npm run build
        
        echo "2я╕ПтГг р╕гр╕▒р╕Щ Unit Tests..."
        npm run test
        
        echo "3я╕ПтГг р╕гр╕▒р╕Щ E2E Tests..."
        npm run test:e2e
        
        echo "тЬЕ р╣Ар╕Чр╕кр╕Хр╣Мр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ!"
        ;;
    4)
        echo "ЁЯУж р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕Чр╕кр╕Хр╣М Order Service..."
        npm run test -- --testPathPattern=order.service
        ;;
    5)
        echo "ЁЯФН р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Др╕нр╕бр╣Др╕Юр╕ер╣М..."
        npx tsc --noEmit --skipLibCheck
        if [ $? -eq 0 ]; then
            echo "тЬЕ р╕Др╕нр╕бр╣Др╕Юр╕ер╣Мр╕Ьр╣Ир╕▓р╕Щ р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф"
        else
            echo "тЭМ р╕бр╕╡р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Др╕нр╕бр╣Др╕Юр╕ер╣М"
        fi
        ;;
    *)
        echo "тЭМ р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕▓р╕вр╣Ар╕ер╕В 1-5"
        ;;
esac

echo ""
echo "ЁЯОЙ р╣Ар╕Чр╕кр╕Хр╣Мр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ!"
