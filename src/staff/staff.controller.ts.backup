import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  Query,
  UseGuards,
  Request,
  Logger,
  BadRequestException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { JwtAuthGuard } from '../auth          hasStaffAccess: staff.permissions?.some((p) => p.includes('staff')),
        },
      },
    };
  }

  /**
   * üë§ ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á staff ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á
   */
  @Get(':id/permissions')
  @Roles(UserRole.ADMIN, UserRole.MANAGER)
  @ApiOperation({
    summary: '‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á staff',
    description: '‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏á staff ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á',
  })
  @ApiResponse({
    status: 200,
    description: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á staff',
  })
  async getStaffPermissions(@Param('id') id: string) {
    this.logger.log(`üìã Getting permissions for staff: ${id}`);

    const staff = await this.staffRepository.findOne({
      where: { id },
      select: [
        'id',
        'staffCode',
        'firstName',
        'lastName',
        'email',
        'role',
        'permissions',
        'status',
        'department',
        'position',
      ],
    });

    if (!staff) {
      throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• staff');
    }

    return {
      success: true,
      message: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á staff ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      data: {
        staff: {
          id: staff.id,
          staffCode: staff.staffCode,
          name: `${staff.firstName} ${staff.lastName}`,
          email: staff.email,
          role: staff.role,
          department: staff.department,
          position: staff.position,
        },
        permissions: {
          current: staff.permissions || [],
          total: staff.permissions?.length || 0,
          hasSystemAccess: staff.permissions?.some((p) => p.includes('system')),
          hasAnalyticsAccess: staff.permissions?.some((p) => p.includes('analytics')),
          hasStaffAccess: staff.permissions?.some((p) => p.includes('staff')),
        },
      },
    };
  }

  /**
   * üîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° IDjwt-auth.guard';
import { RolesGuard } from '../auth/guards/roles.guard';
import { Roles } from '../auth/decorators/roles.decorator';
import { UserRole } from '../common/enums';
import {
  ApiTags,
  ApiOperation,
  ApiResponse,
  ApiBearerAuth,
} from '@nestjs/swagger';
import { CreateStaffDto } from './dto/create-staff.dto';
import { UpdateStaffDto } from './dto/update-staff.dto';
import { Staff, StaffStatus, StaffRole, StaffPermission } from './staff.entity';

@ApiTags('üë• Staff Management - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')
@Controller('staff')
@UseGuards(JwtAuthGuard, RolesGuard)
@ApiBearerAuth()
export class StaffController {
  private readonly logger = new Logger(StaffController.name);

  constructor(
    @InjectRepository(Staff)
    private staffRepository: Repository<Staff>,
  ) {}

  /**
   * üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
   */
  @Post()
  @Roles(UserRole.ADMIN)
  @ApiOperation({
    summary: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
    description: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
  })
  @ApiResponse({ status: 201, description: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  @ApiResponse({ status: 409, description: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ã‡πâ‡∏≥' })
  async create(@Body() createStaffDto: CreateStaffDto, @Request() req) {
    try {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const existingStaff = await this.staffRepository.findOne({
        where: { email: createStaffDto.email },
      });

      if (existingStaff) {
        throw new BadRequestException('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      const staffCode = await this.generateStaffCode();

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á permissions ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏° role
      const permissions = this.getDefaultPermissions(createStaffDto.role);

      const staff = this.staffRepository.create({
        ...createStaffDto,
        staffCode,
        permissions: createStaffDto.permissions || permissions,
        createdBy: req.user.id,
      });

      const result = await this.staffRepository.save(staff);

      this.logger.log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà: ${staffCode}`);

      return {
        success: true,
        message: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data: result,
      };
    } catch (error) {
      this.logger.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:', error);
      throw error;
    }
  }

  /**
   * üìã ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   */
  @Get()
  @Roles(UserRole.ADMIN, UserRole.STAFF)
  @ApiOperation({
    summary: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
    description: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
  })
  @ApiResponse({ status: 200, description: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  async findAll(
    @Query('status') status?: StaffStatus,
    @Query('role') role?: StaffRole,
    @Query('department') department?: string,
    @Query('search') search?: string,
    @Query('page') page: number = 1,
    @Query('limit') limit: number = 10,
  ) {
    try {
      const skip = (page - 1) * limit;

      const queryBuilder = this.staffRepository
        .createQueryBuilder('staff')
        .leftJoinAndSelect('staff.user', 'user');

      // Filter conditions
      if (status) {
        queryBuilder.andWhere('staff.status = :status', { status });
      }

      if (role) {
        queryBuilder.andWhere('staff.role = :role', { role });
      }

      if (department) {
        queryBuilder.andWhere('staff.department = :department', {
          department,
        });
      }

      if (search) {
        queryBuilder.andWhere(
          '(staff.firstName ILIKE :search OR staff.lastName ILIKE :search OR staff.email ILIKE :search OR staff.staffCode ILIKE :search)',
          { search: `%${search}%` },
        );
      }

      queryBuilder.orderBy('staff.createdAt', 'DESC').skip(skip).take(limit);

      const [data, total] = await queryBuilder.getManyAndCount();

      const summary = await this.getStaffSummary();

      return {
        success: true,
        message: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data,
        pagination: {
          page,
          limit,
          total,
          totalPages: Math.ceil(total / limit),
        },
        summary,
      };
    } catch (error) {
      this.logger.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:', error);
      throw error;
    }
  }

  /**
   * üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
   */
  @Get('analytics/summary')
  @Roles(UserRole.ADMIN, UserRole.STAFF)
  @ApiOperation({
    summary: '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
    description: '‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°',
  })
  @ApiResponse({ status: 200, description: '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  async getSummary() {
    try {
      const result = await this.getStaffSummary();
      return {
        success: true,
        message: '‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data: result,
      };
    } catch (error) {
      this.logger.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:', error);
      throw error;
    }
  }

  /**
   * ÔøΩ ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   */
  @Get('permissions')
  @Roles(UserRole.ADMIN, UserRole.STAFF)
  @ApiOperation({
    summary: '‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
    description: '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ permissions ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
  })
  @ApiResponse({
    status: 200,
    description: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ permissions ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
  })
  async getAllPermissions() {
    this.logger.log('üìã Getting all available permissions');

    const permissions = Object.values(StaffPermission);
    const permissionGroups = {
      analytics: permissions.filter(
        (p) => p.includes('analytics') || p.includes('reports'),
      ),
      staff: permissions.filter((p) => p.includes('staff')),
      orders: permissions.filter((p) => p.includes('orders')),
      system: permissions.filter(
        (p) =>
          p.includes('system') || p.includes('settings') || p.includes('audit'),
      ),
      performance: permissions.filter(
        (p) => p.includes('performance') || p.includes('monitoring'),
      ),
    };

    return {
      success: true,
      message: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• permissions ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      data: {
        all: permissions,
        groups: permissionGroups,
        total: permissions.length,
      },
    };
  }

  /**
   * üéØ ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö staff ‡∏ó‡∏µ‡πà login ‡πÅ‡∏•‡πâ‡∏ß)
   */
  @Get('my/permissions')
  @Roles(UserRole.STAFF, UserRole.ADMIN, UserRole.MANAGER)
  @ApiOperation({
    summary: '‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á',
    description: 'staff ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ',
  })
  @ApiResponse({
    status: 200,
    description: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á',
  })
  async getMyPermissions(@Request() req) {
    this.logger.log(`üìã Getting my permissions for user: ${req.user?.email}`);

    if (!req.user?.email) {
      throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    }

    const staff = await this.staffRepository.findOne({
      where: { email: req.user.email },
      select: [
        'id',
        'staffCode',
        'firstName',
        'lastName',
        'email',
        'role',
        'status',
        'permissions',
        'department',
        'position',
      ],
    });

    if (!staff) {
      throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• staff ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ');
    }

    return {
      success: true,
      message: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      data: {
        staff: {
          id: staff.id,
          staffCode: staff.staffCode,
          name: `${staff.firstName} ${staff.lastName}`,
          email: staff.email,
          role: staff.role,
          department: staff.department,
          position: staff.position,
        },
        permissions: {
          current: staff.permissions || [],
          total: staff.permissions?.length || 0,
          hasSystemAccess: staff.permissions?.some((p) =>
            p.includes('system'),
          ),
          hasAnalyticsAccess: staff.permissions?.some((p) =>
            p.includes('analytics'),
          ),
          hasStaffAccess: staff.permissions?.some((p) => p.includes('staff')),
        },
      },
    };
  }

  /**
   * ÔøΩüîç ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° ID
   */
  @Get(':id')
  @Roles(UserRole.ADMIN, UserRole.STAFF)
  @ApiOperation({
    summary: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
    description: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏° ID',
  })
  @ApiResponse({ status: 200, description: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  @ApiResponse({ status: 404, description: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' })
  async findOne(@Param('id') id: string) {
    try {
      const staff = await this.staffRepository.findOne({
        where: { id },
        relations: ['user'],
      });

      if (!staff) {
        throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
      }

      return {
        success: true,
        message: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data: staff,
      };
    } catch (error) {
      this.logger.error(
        `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ID: ${id}:`,
        error,
      );
      throw error;
    }
  }

  /**
   * ‚úèÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
   */
  @Patch(':id')
  @Roles(UserRole.ADMIN)
  @ApiOperation({
    summary: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
    description: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
  })
  @ApiResponse({ status: 200, description: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  async update(
    @Param('id') id: string,
    @Body() updateStaffDto: UpdateStaffDto,
    @Request() req,
  ) {
    try {
      const staff = await this.staffRepository.findOne({ where: { id } });

      if (!staff) {
        throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ã‡πâ‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•)
      if (updateStaffDto.email && updateStaffDto.email !== staff.email) {
        const existingStaff = await this.staffRepository.findOne({
          where: { email: updateStaffDto.email },
        });

        if (existingStaff) {
          throw new BadRequestException('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
        }
      }

      const result = await this.staffRepository.save({
        ...staff,
        ...updateStaffDto,
        updatedBy: req.user.id,
      });

      return {
        success: true,
        message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data: result,
      };
    } catch (error) {
      this.logger.error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ID: ${id}:`, error);
      throw error;
    }
  }

  /**
   * üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
   */
  @Patch(':id/status')
  @Roles(UserRole.ADMIN)
  @ApiOperation({
    summary: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
    description: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)',
  })
  @ApiResponse({ status: 200, description: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  async updateStatus(
    @Param('id') id: string,
    @Body('status') status: StaffStatus,
    @Request() req,
  ) {
    if (!Object.values(StaffStatus).includes(status)) {
      throw new BadRequestException('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }

    try {
      const staff = await this.staffRepository.findOne({ where: { id } });

      if (!staff) {
        throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
      }

      const result = await this.staffRepository.save({
        ...staff,
        status,
        updatedBy: req.user.id,
      });

      this.logger.log(
        `‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${staff.staffCode} -> ${status}`,
      );

      return {
        success: true,
        message: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data: result,
      };
    } catch (error) {
      this.logger.error(
        `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ID: ${id}:`,
        error,
      );
      throw error;
    }
  }

  /**
   * üóëÔ∏è ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
   */
  @Delete(':id')
  @Roles(UserRole.ADMIN)
  @ApiOperation({
    summary: '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
    description: '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô TERMINATED)',
  })
  @ApiResponse({ status: 200, description: '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  async remove(@Param('id') id: string, @Request() req) {
    try {
      const staff = await this.staffRepository.findOne({ where: { id } });

      if (!staff) {
        throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
      }

      // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô TERMINATED ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
      await this.staffRepository.save({
        ...staff,
        status: StaffStatus.TERMINATED,
        updatedBy: req.user.id,
      });

      this.logger.log(`‚úÖ ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${staff.staffCode}`);

      return {
        success: true,
        message: '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      };
    } catch (error) {
      this.logger.error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ID: ${id}:`, error);
      throw error;
    }
  }

  /**
   * üè¢ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å
   */
  @Get('meta/departments')
  @Roles(UserRole.ADMIN, UserRole.STAFF)
  @ApiOperation({
    summary: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å',
    description: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
  })
  @ApiResponse({ status: 200, description: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' })
  async getDepartments() {
    try {
      const departments = await this.getDepartmentsList();

      return {
        success: true,
        message: '‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        data: departments,
      };
    } catch (error) {
      this.logger.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å:', error);
      throw error;
    }
  }

  /**
   * üîë ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   */
  @Get('permissions')
  @Roles(UserRole.ADMIN, UserRole.STAFF)
  @ApiOperation({
    summary: '‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
    description: '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ permissions ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
  })
  @ApiResponse({
    status: 200,
    description: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ permissions ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
  })
  async getAllPermissions() {
    this.logger.log('üìã Getting all available permissions');

    const permissions = Object.values(StaffPermission);
    const permissionGroups = {
      analytics: permissions.filter(
        (p) => p.includes('analytics') || p.includes('reports'),
      ),
      staff: permissions.filter((p) => p.includes('staff')),
      orders: permissions.filter((p) => p.includes('orders')),
      system: permissions.filter(
        (p) =>
          p.includes('system') || p.includes('settings') || p.includes('audit'),
      ),
      performance: permissions.filter(
        (p) => p.includes('performance') || p.includes('monitoring'),
      ),
    };

    return {
      success: true,
      message: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• permissions ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      data: {
        all: permissions,
        groups: permissionGroups,
        total: permissions.length,
      },
    };
  }

  /**
   * üë§ ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á staff ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á
   */
  @Get(':id/permissions')
  @Roles(UserRole.ADMIN, UserRole.MANAGER)
  @ApiOperation({
    summary: '‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á staff',
    description: '‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏á staff ‡∏Ñ‡∏ô‡πÉ‡∏î‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á',
  })
  @ApiResponse({
    status: 200,
    description: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á staff',
  })
  async getStaffPermissions(@Param('id') id: string) {
    this.logger.log(`üìã Getting permissions for staff: ${id}`);

    const staff = await this.staffRepository.findOne({
      where: { id },
      select: [
        'id',
        'staffCode',
        'firstName',
        'lastName',
        'email',
        'role',
        'permissions',
        'status',
      ],
    });

    if (!staff) {
      throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• staff');
    }

    const allPermissions = Object.values(StaffPermission);
    const hasPermissions = staff.permissions || [];
    const missingPermissions = allPermissions.filter(
      (p) => !hasPermissions.includes(p),
    );

    return {
      success: true,
      message: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå staff ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      data: {
        staff: {
          id: staff.id,
          staffCode: staff.staffCode,
          fullName: `${staff.firstName} ${staff.lastName}`,
          email: staff.email,
          role: staff.role,
          status: staff.status,
        },
        permissions: {
          has: hasPermissions,
          missing: missingPermissions,
          total: hasPermissions.length,
          percentage: Math.round(
            (hasPermissions.length / allPermissions.length) * 100,
          ),
        },
      },
    };
  }

  /**
   * üéØ ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö staff ‡∏ó‡∏µ‡πà login ‡πÅ‡∏•‡πâ‡∏ß)
   */
  @Get('my/permissions')
  @Roles(UserRole.STAFF, UserRole.ADMIN, UserRole.MANAGER)
  @ApiOperation({
    summary: '‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á',
    description: 'staff ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ',
  })
  @ApiResponse({
    status: 200,
    description: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á',
  })
  async getMyPermissions(@Request() req) {
    this.logger.log(`üìã Getting my permissions for user: ${req.user?.email}`);

    if (!req.user?.email) {
      throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    }

    const staff = await this.staffRepository.findOne({
      where: { email: req.user.email },
      select: [
        'id',
        'staffCode',
        'firstName',
        'lastName',
        'email',
        'role',
        'permissions',
        'status',
        'department',
        'position',
      ],
    });

    if (!staff) {
      throw new BadRequestException('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• staff ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ');
    }

    const permissions = staff.permissions || [];
    const permissionGroups = {
      analytics: permissions.filter(
        (p) => p.includes('analytics') || p.includes('reports'),
      ),
      staff: permissions.filter((p) => p.includes('staff')),
      orders: permissions.filter((p) => p.includes('orders')),
      system: permissions.filter(
        (p) =>
          p.includes('system') || p.includes('settings') || p.includes('audit'),
      ),
      performance: permissions.filter(
        (p) => p.includes('performance') || p.includes('monitoring'),
      ),
    };

    return {
      success: true,
      message: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      data: {
        profile: {
          id: staff.id,
          staffCode: staff.staffCode,
          fullName: `${staff.firstName} ${staff.lastName}`,
          email: staff.email,
          role: staff.role,
          status: staff.status,
          department: staff.department,
          position: staff.position,
        },
        permissions: {
          list: permissions,
          groups: permissionGroups,
          total: permissions.length,
        },
        capabilities: {
          canViewAnalytics: permissions.includes(
            StaffPermission.VIEW_ANALYTICS,
          ),
          canManageStaff: permissions.includes(StaffPermission.MANAGE_STAFF),
          canManageOrders: permissions.includes(StaffPermission.MANAGE_ORDERS),
          canViewPerformance: permissions.includes(
            StaffPermission.VIEW_PERFORMANCE,
          ),
          canAccessAudit: permissions.includes(StaffPermission.AUDIT_LOGS),
        },
      },
    };
  }

  // Private methods
  private async generateStaffCode(): Promise<string> {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2);
    const month = (now.getMonth() + 1).toString().padStart(2, '0');

    const count = await this.staffRepository.count();
    const sequence = (count + 1).toString().padStart(4, '0');

    return `STF${year}${month}${sequence}`;
  }

  private getDefaultPermissions(role: StaffRole): StaffPermission[] {
    const permissionMap = {
      [StaffRole.ADMIN]: Object.values(StaffPermission),
      [StaffRole.MANAGER]: [
        StaffPermission.VIEW_ANALYTICS,
        StaffPermission.EXPORT_REPORTS,
        StaffPermission.VIEW_STAFF,
        StaffPermission.MANAGE_ORDERS,
        StaffPermission.CANCEL_ORDERS,
        StaffPermission.VIEW_PERFORMANCE,
      ],
      [StaffRole.SUPERVISOR]: [
        StaffPermission.VIEW_ANALYTICS,
        StaffPermission.VIEW_STAFF,
        StaffPermission.MANAGE_ORDERS,
        StaffPermission.VIEW_PERFORMANCE,
      ],
      [StaffRole.STAFF]: [
        StaffPermission.VIEW_STAFF,
        StaffPermission.MANAGE_ORDERS,
      ],
    };

    return permissionMap[role] || [];
  }

  private async getStaffSummary() {
    const [
      total,
      active,
      inactive,
      suspended,
      terminated,
      byRole,
      byDepartment,
    ] = await Promise.all([
      this.staffRepository.count(),
      this.staffRepository.count({ where: { status: StaffStatus.ACTIVE } }),
      this.staffRepository.count({ where: { status: StaffStatus.INACTIVE } }),
      this.staffRepository.count({ where: { status: StaffStatus.SUSPENDED } }),
      this.staffRepository.count({ where: { status: StaffStatus.TERMINATED } }),
      this.getStaffByRole(),
      this.getStaffByDepartment(),
    ]);

    return {
      total,
      byStatus: {
        active,
        inactive,
        suspended,
        terminated,
      },
      byRole,
      byDepartment,
      utilization: {
        activePercentage: total > 0 ? Math.round((active / total) * 100) : 0,
        inactivePercentage:
          total > 0
            ? Math.round(((inactive + suspended + terminated) / total) * 100)
            : 0,
      },
    };
  }

  private async getStaffByRole() {
    const result = await this.staffRepository
      .createQueryBuilder('staff')
      .select('staff.role', 'role')
      .addSelect('COUNT(*)', 'count')
      .groupBy('staff.role')
      .getRawMany();

    return result.reduce((acc, item) => {
      acc[item.role] = parseInt(item.count);
      return acc;
    }, {});
  }

  private async getStaffByDepartment() {
    const result = await this.staffRepository
      .createQueryBuilder('staff')
      .select('staff.department', 'department')
      .addSelect('COUNT(*)', 'count')
      .where('staff.department IS NOT NULL')
      .groupBy('staff.department')
      .getRawMany();

    return result.reduce((acc, item) => {
      acc[item.department] = parseInt(item.count);
      return acc;
    }, {});
  }

  private async getDepartmentsList() {
    const result = await this.staffRepository
      .createQueryBuilder('staff')
      .select('DISTINCT staff.department', 'department')
      .where('staff.department IS NOT NULL')
      .andWhere('staff.department != :empty', { empty: '' })
      .orderBy('staff.department', 'ASC')
      .getRawMany();

    return result.map((item) => item.department);
  }
}
